#!/bin/bash

# Define the connections file path
connections_file="$HOME/.connections"

# Function to list all domains with numbers, sorted alphabetically by domain
list_domains() {
  echo "Available connections:"
  # Sort the connections file by domain (first field) and then number the results
  awk -F',' '{print $1}' "$connections_file" | sort | nl -w1 -s". " | column -c $(tput cols)
}

# Function to add a new entry to the connections file
add_entry() {
  read -p "Enter domain: " domain
  read -p "Enter username: " username
  read -p "Enter IP address: " ip_address

  # Check if the domain already exists
  if grep -q "^$domain," "$connections_file"; then
    echo "ERROR: Domain $domain already exists."
    exit 1
  fi

  # Append the new entry to the connections file
  echo "$domain,$username,$ip_address" >> "$connections_file"
  echo "New entry added: $domain,$username,$ip_address"
}

# Function to list connections grouped by IP address, sorted alphabetically within each IP group
list_by_server() {
  echo "Connections grouped by IP:"
  awk -F',' '{ print $3,$1,$2 }' "$connections_file" | sort -t' ' -k1,1 -k2,2 | nl -w1 -s". " | column -t

  # Prompt for a number selection
  read -p "Select a number to proceed: " selection_number

  # Get the selected entry
  selected_line=$(awk -F',' '{ print $3,$1,$2 }' "$connections_file" | sort -t' ' -k1,1 -k2,2 | nl -w1 -s". " | awk "NR==$selection_number")

  # If no match, show error
  if [ -z "$selected_line" ]; then
    echo "ERROR: Invalid selection."
    exit 1
  fi

  # Extract domain, username, and IP from the selected line
  ip_address=$(echo "$selected_line" | awk '{print $2}')
  domain=$(echo "$selected_line" | awk '{print $3}')
  username=$(echo "$selected_line" | awk '{print $4}')

  # Provide the next action prompt
  read -p "You've selected $domain. Would you like to connect (y), edit (edit), or delete (del)? [y/edit/del] " action

  # Handle the selected action
  case "$action" in
    y)
      ssh_command="ssh $username@$ip_address"
      echo "$ssh_command" | pbcopy
      echo "The connection for \`$ssh_command\` is now available via CMD+V."
      ;;
    edit)
      echo "Editing $domain:"
      read -p "Enter new domain (or press Enter to keep '$domain'): " new_domain
      read -p "Enter new username (or press Enter to keep '$username'): " new_username

      # Use existing domain/username if the user presses Enter
      new_domain=${new_domain:-$domain}
      new_username=${new_username:-$username}

      # Update the connection in the file
      sed -i '' "s|^$domain,$username,$ip_address|$new_domain,$new_username,$ip_address|" "$connections_file"
      echo "Entry updated."
      ;;
    del)
      echo "Deleting $domain..."
      sed -i '' "/^$domain,$username,$ip_address/d" "$connections_file"
      echo "$domain has been deleted."
      ;;
    *)
      echo "Invalid option. Exiting."
      exit 1
      ;;
  esac
}

# Check if the connections file exists
if [ ! -f "$connections_file" ]; then
  echo "ERROR: No ~/.connections file found."
  exit 1
fi

# Check if the script was run with the --list option
if [ "$1" == "--list" ]; then
  list_domains

  # Prompt the user to select a number
  read -p "Enter the number corresponding to the domain: " domain_number

  # Validate the input as a number
  if ! [[ "$domain_number" =~ ^[0-9]+$ ]]; then
    echo "ERROR: Invalid input. Please enter a number."
    exit 1
  fi

  # Get the domain for the chosen number (sorted order)
  chosen_domain=$(awk -F',' '{print $1}' "$connections_file" | sort | awk "NR==$domain_number")

  # Check if a domain was found
  if [ -z "$chosen_domain" ]; then
    echo "ERROR: No domain found for number $domain_number."
    exit 1
  fi

  # Run the script as if the user had entered the domain
  $0 "$chosen_domain"
  exit 0
fi

# Check if the script was run with the --add option
if [ "$1" == "--add" ]; then
  add_entry
  exit 0
fi

# Check if the script was run with the --by-server option
if [ "$1" == "--by-server" ]; then
  list_by_server
  exit 0
fi

# Regular domain handling flow
domain_input=$1

# Check if a domain was provided
if [ -z "$domain_input" ]; then
  echo "ERROR: Please provide a domain as input or use the --list option."
  exit 1
fi

# Search for matching domain entries
matches=$(grep "^$domain_input," "$connections_file")

# Count the number of matches
match_count=$(echo "$matches" | wc -l)

# Handle different cases for match count
if [ "$match_count" -eq 0 ]; then
  echo "No connection found for $domain_input."
  exit 0
elif [ "$match_count" -gt 1 ]; then
  echo "ERROR: Multiple entries for $domain_input. Please edit your ~/.connections file to have only one line for this domain."
  exit 1
else
  # Extract user and IP address from the matched row
  user=$(echo "$matches" | cut -d',' -f2)
  ip_address=$(echo "$matches" | cut -d',' -f3)

  # Create the ssh command
  ssh_command="ssh $user@$ip_address"

  # Copy the ssh command to the clipboard (using pbcopy for macOS)
  echo "$ssh_command" | pbcopy

  # Inform the user
  echo "The connection for \`$ssh_command\` is now available via CMD+V."
fi
